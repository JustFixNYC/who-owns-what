// Set up DB instance
const Promise = require('bluebird');
const pgp = require('pg-promise')({ promiseLib: Promise });
const db = pgp(process.env.DATABASE_URL);

// PLUTO Building Info Query for when BBL is not found
const buildingInfoSQL = 
  `SELECT 
	   ADDRESS FORMATTED_ADDRESS,
	   SPLIT_PART( ADDRESS, ' ' , 1 ) HOUSENUMBER,
	   SUBSTR(ADDRESS, STRPOS(ADDRESS, ' ') + 1) STREETNAME,
	   BLDGCLASS,
	   LAT LATITUDE,
	   LNG LONGITUDE
   FROM PLUTO_18V2
   WHERE BBL = $1`


// WOW Timeline Custom Queries
const saleHistorySQL = 
  `SELECT * 
   FROM REAL_PROPERTY_LEGALS L 
   LEFT JOIN REAL_PROPERTY_MASTER M ON L.DOCUMENTID = M.DOCUMENTID
   WHERE BBL = $1 AND DOCTYPE = 'DEED'
   ORDER BY COALESCE(DOCDATE,RECORDEDFILED) DESC`;

const indicatorHistorySQL = 
	`WITH TIME_SERIES AS (
      SELECT TO_CHAR(I::DATE , 'YYYY-MM') AS MONTH 
      FROM GENERATE_SERIES('2010-01-01', CURRENT_DATE - INTERVAL '1 MONTH', '1 MONTH'::INTERVAL) I
    ),
    
    HPD_VIOLATIONS AS (
      SELECT
        TO_CHAR(NOVISSUEDDATE, 'YYYY-MM') AS MONTH,
        COUNT(*) FILTER (WHERE CLASS = 'A') AS HPD_VIOLATIONS_CLASS_A,
        COUNT(*) FILTER (WHERE CLASS = 'B') AS HPD_VIOLATIONS_CLASS_B,
        COUNT(*) FILTER (WHERE CLASS = 'C') AS HPD_VIOLATIONS_CLASS_C,
        COUNT(*) FILTER (WHERE CLASS IS NOT NULL) AS HPD_VIOLATIONS_TOTAL
      FROM HPD_VIOLATIONS
      WHERE BBL = $1
      AND NOVISSUEDDATE >= '2010-01-01'
      GROUP BY MONTH
    ),

    HPD_COMPLAINTS AS (
      SELECT 
        TO_CHAR(RECEIVEDDATE, 'YYYY-MM') AS MONTH, 
        COUNT(*) FILTER (WHERE TYPEID = ANY('{1,2,4}')) AS HPD_COMPLAINTS_EMERGENCY,
        COUNT(*) FILTER (WHERE TYPEID = ANY('{3,8}')) AS HPD_COMPLAINTS_NONEMERGENCY,
        COUNT(*) FILTER (WHERE TYPEID IS NOT NULL) AS HPD_COMPLAINTS_TOTAL
      FROM HPD_COMPLAINT_PROBLEMS P
      LEFT JOIN HPD_COMPLAINTS C ON P.COMPLAINTID = C.COMPLAINTID
      WHERE BBL = $1
      AND RECEIVEDDATE >= '2010-01-01'
      GROUP BY MONTH
    ),

    DOB_PERMITS AS (
      SELECT 
          TO_CHAR(PREFILINGDATE, 'YYYY-MM') AS MONTH, 
          COUNT(*) FILTER (WHERE JOBTYPE IS NOT NULL) AS DOB_PERMITS_TOTAL
      FROM DOBJOBS
      WHERE BBL = $1
      AND PREFILINGDATE >= '2010-01-01'
      GROUP BY MONTH
    ),

    DOB_VIOLATIONS AS (
      SELECT
          TO_CHAR(ISSUEDATE, 'YYYY-MM') AS MONTH,
          COUNT(*) FILTER (WHERE VIOLATIONTYPECODE='EGNCY' OR VIOLATIONTYPECODE='IMEGNCY') DOB_VIOLATIONS_EMERGENCY,
          COUNT(*) FILTER (WHERE VIOLATIONTYPECODE!= 'EGNCY' OR VIOLATIONTYPECODE != 'IMEGNCY') DOB_VIOLATIONS_NONEMERGENCY,
          COUNT(*) FILTER (WHERE VIOLATIONTYPECODE IS NOT NULL) DOB_VIOLATIONS_TOTAL
      FROM DOB_VIOLATIONS
      WHERE BBL = $1
      AND ISSUEDATE >= '2010-01-01'
      GROUP BY MONTH
    ),

    ECB_VIOLATIONS AS (
      SELECT
          TO_CHAR(ISSUEDATE, 'YYYY-MM') AS MONTH,
          COUNT(*) FILTER (WHERE SEVERITY IS NOT NULL) AS ECB_VIOLATIONS_TOTAL
      FROM ECB_VIOLATIONS
      WHERE BBL = $1
      AND ISSUEDATE >= '2010-01-01'
      GROUP BY MONTH
    )

  SELECT 
      T.MONTH,
      COALESCE(HPD_VIOLATIONS_CLASS_A, 0) AS HPD_VIOLATIONS_CLASS_A,
      COALESCE(HPD_VIOLATIONS_CLASS_B, 0) AS HPD_VIOLATIONS_CLASS_B,
      COALESCE(HPD_VIOLATIONS_CLASS_C, 0) AS HPD_VIOLATIONS_CLASS_C,
      COALESCE(HPD_VIOLATIONS_TOTAL, 0) AS HPD_VIOLATIONS_TOTAL,
      COALESCE(HPD_COMPLAINTS_EMERGENCY, 0) AS HPD_COMPLAINTS_EMERGENCY,
      COALESCE(HPD_COMPLAINTS_NONEMERGENCY, 0) AS HPD_COMPLAINTS_NONEMERGENCY,
      COALESCE(HPD_COMPLAINTS_TOTAL, 0) AS HPD_COMPLAINTS_TOTAL,
      COALESCE(DOB_PERMITS_TOTAL, 0) AS DOB_PERMITS_TOTAL,
      COALESCE(DOB_VIOLATIONS_EMERGENCY, 0) AS DOB_VIOLATIONS_EMERGENCY,
      COALESCE(DOB_VIOLATIONS_NONEMERGENCY, 0) AS DOB_VIOLATIONS_NONEMERGENCY,
      COALESCE(DOB_VIOLATIONS_TOTAL, 0) AS DOB_VIOLATIONS_TOTAL,
      COALESCE(ECB_VIOLATIONS_TOTAL, 0) AS ECB_VIOLATIONS_TOTAL
  FROM TIME_SERIES T
  LEFT JOIN HPD_VIOLATIONS HV ON T.MONTH = HV.MONTH
  LEFT JOIN HPD_COMPLAINTS HC ON T.MONTH = HC.MONTH
  LEFT JOIN DOB_PERMITS DP ON T.MONTH = DP.MONTH
  LEFT JOIN DOB_VIOLATIONS DV ON T.MONTH = DV.MONTH
  LEFT JOIN ECB_VIOLATIONS EV ON T.MONTH = EV.MONTH
  ORDER BY T.MONTH ASC`;

module.exports = {
  queryAddress: bbl => db.func('get_assoc_addrs_from_bbl', bbl),
  queryAggregate: bbl => db.func('get_agg_info_from_bbl', bbl),
  queryLandlord: bbl => db.any('SELECT * FROM hpd_landlord_contact WHERE bbl = $1', bbl),
  queryBuildingInfo: bbl => db.any(buildingInfoSQL, bbl),
  querySaleHistory: bbl => db.any(saleHistorySQL, bbl),
  queryIndicatorHistory: bbl => db.any(indicatorHistorySQL, bbl)
};
